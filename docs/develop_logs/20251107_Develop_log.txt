# 2025년 11월 7일 개발 로그

## 1. 신규 기능: 첩자(Spy) '정보 취득' 및 '귀환' 시스템 구현

게임의 핵심 시스템 중 하나인 첩자의 특수 능력을 백엔드 로직부터 프론트엔드 UI까지 전체적으로 구현했습니다.

### 1.1. 핵심 로직 리팩토링: '행동(Action)' 시스템 도입
- **목적**: 단순 이동(move)을 넘어 '정보 취득', '귀환' 등 다양한 종류의 기물 행동을 처리하기 위한 기반 마련.
- **`core-logic` 수정**:
    - `MoveIntent` 타입을 `GameAction`(`MoveAction`, `GatherInfoAction`, `ReturnAction`의 합집합) 타입으로 확장했습니다.
    - `getValidMoves` -> `getValidActions`로, `movePiece` -> `performAction`으로 함수를 리팩토링하여 다양한 행동을 처리할 수 있는 구조를 완성했습니다.
    - `GameState`에 `infoGatheredTiles`, `spiesReadyToReturn` 등 첩자 상태 추적을 위한 속성을 추가했습니다.

### 1.2. 프론트엔드 상태 관리 및 UI 구현
- **`gameStore` 리팩토링**: 로컬 플레이 기능 구현을 위해, 기존의 `socket.io` 기반 로직을 로컬 `core-logic` 함수(`performAction`)를 직접 호출하는 방식으로 대대적으로 수정했습니다.
- **`ActionChoiceModal.tsx` 컴포넌트 생성**: 첩자가 '정보 취득'과 '이동' 중 하나를 선택할 수 있는 모달 UI를 구현했습니다.
- **컴포넌트 연동**: `App.tsx`, `Board.tsx` 등 관련 컴포넌트들을 새로운 `gameStore` 로직과 `ActionChoiceModal`에 맞게 모두 수정하여, 첩자 선택 시 모달이 정상적으로 표시되도록 구현했습니다.

## 2. 게임플레이 개선 및 버그 수정

### 2.1. '귀환' 시스템 개선 (사용자 피드백 기반)
- **문제점**: 정보 취득 후 첩자가 보드에 남아있어 상대에게 잡힐 수 있고, UI가 혼란스러웠습니다.
- **개선**: '정보 취득' 시 첩자가 즉시 보드에서 사라져 '귀환 대기' 상태(`returningSpies`)로 들어가도록 규칙을 개선했습니다. 이로써 상대에게 잡힐 위험 없이 안전하게 귀환할 수 있게 되었습니다.
- **귀환 방식 구현**: 플레이어가 자신의 턴에 비어있는 아군 영역 타일을 클릭하면, 대기 중인 첩자가 해당 위치로 즉시 귀환하도록 `gameStore`의 `handleTileClick` 로직을 수정했습니다.

### 2.2. 행동 선택 UI 상호작용 수정
- **문제점**: 행동 선택 모달에서 'Move' 버튼을 클릭하면 이동 위치를 선택하는 대신, 첫 번째 가능한 경로로 자동 이동하는 문제가 있었습니다.
- **해결**: 'Move' 버튼의 역할을 '이동 실행'에서 '이동 모드 진입'으로 변경했습니다. `gameStore`에 `enterMoveMode` 함수를 추가하여, 모달만 닫고 기물 선택 및 이동 가능 범위 표시 상태는 유지하도록 수정했습니다.

### 2.3. 실행 오류 해결
- **원인**: `remix-app`(백엔드 서버)이 리팩토링 이전의 `getValidMoves` 함수를 참조하고 있어 서버 실행에 실패했습니다.
- **해결**: `remix-app/server.ts`가 새로운 `getValidActions`와 `performAction`을 사용하도록 코드를 수정하여 서버가 정상적으로 실행되도록 조치했습니다.

## 3. 문서 수정

- **규칙서 업데이트**: `docs/CheDuk_Rulebook_KOR.md` 파일의 '영역(Territory)' 정의가 실제 구현과 다른 점을 발견하고, 현재의 '쐐기 모양' 규칙에 맞게 내용을 수정했습니다.

## 4. 요약 및 현재 상태

- 첩자의 핵심 기능인 '정보 취득'과 '귀환' 시스템의 백엔드 로직 및 프론트엔드 UI 구현이 모두 완료되었습니다.
- 사용자 피드백을 반영하여 '귀환' 중인 첩자가 잡힐 수 없도록 시스템을 개선하고, 관련 UI 상호작용을 다듬었습니다.
- 프로젝트 실행을 방해하던 백엔드 서버의 오류를 해결했습니다.
- 이제 첩자 관련 기능이 의도대로 정상 작동하며, 다음 고급 시스템을 구현할 준비가 되었습니다.

## 5. 다음에 작업할 내용 (Next Steps)

첩자 시스템이 완성됨에 따라, 이제 남아있는 다른 고급 시스템들을 구현할 차례입니다. 다음 우선순위에 따라 작업을 진행할 것을 제안합니다.

1.  **첩자 및 대사 부활 시스템 구현:**
    *   **첩자(Spy):** 포획되었을 경우, 1턴을 소모하여 아군 영역 내 빈칸에서 부활하는 액션을 추가합니다.
    *   **대사(Ambassador):** 포획되었을 경우, 1턴을 소모하여 비어있는 자신의 대사관에서 부활하는 액션을 추가합니다.
    *   이를 위해 포획된 기물 목록(`capturedPieces`)을 UI에 표시하고, 부활 가능한 기물을 선택하여 액션을 실행하는 흐름을 구현해야 합니다.

2.  **캐슬링 및 수반 이동 제한 구현:**
    *   **수반(Chief) 이동 제한:** 캐슬링을 사용하기 전까지 수반이 자신의 영역 밖으로 나갈 수 없도록 `getValidActions` 로직을 수정합니다.
    *   **캐슬링(Castling):** 수반과 외교관(Diplomat)의 위치를 맞바꾸는 특수 액션을 구현합니다.

3.  **경호원 보호 규칙 구현:**
    *   **수반 보호(Chief Protection):** 상대방이 수반을 공격했을 때, 인접한 경호원이 대신 제거되는 방어 규칙을 `applyAction` 함수에 구현합니다.